"""
Сервис для работы с OpenAI API.
"""
import base64
import json
from openai import OpenAI
from backend.config import settings
from backend.models.schemas import CompetitorAnalysis, ImageAnalysis

class OpenAIService:
    """
    Сервис для анализа текста и изображений через OpenAI.
    """
    def __init__(self):
        self.client = OpenAI(api_key=settings.OPENAI_API_KEY)
        self.model = settings.OPENAI_MODEL
        self.vision_model = settings.OPENAI_VISION_MODEL

    def analyze_text(self, text: str) -> CompetitorAnalysis:
        """
        Анализирует текст конкурента через GPT-4o.

        Args:
            text (str): Текст конкурента.

        Returns:
            CompetitorAnalysis: Структурированный анализ.
        """
        # Системный промпт для экспертного анализа текста
        system_prompt = (
            "Ты — профессиональный маркетолог и аналитик конкурентной среды. "
            "Проанализируй предоставленный текст конкурента максимально глубоко и структурированно. "
            "Ответ строго в формате JSON с ключами: strengths (сильные стороны, 3-5), weaknesses (слабые стороны, 3-5), "
            "unique_offers (уникальные предложения, 2-3), recommendations (конкретные рекомендации по улучшению стратегии, 3-5), summary (краткое резюме, 1-2 предложения). "
            "Оцени реальные конкурентные преимущества, недостатки, УТП, предложи практические шаги для усиления позиций. "
            "Пиши на русском, избегай общих фраз, используй профессиональную лексику."
        )
        # TODO: Реализовать реальный запрос к OpenAI GPT-4o с этим промптом
        return CompetitorAnalysis(
            strengths=["Сильный узнаваемый бренд на рынке", "Высокий уровень клиентского сервиса", "Широкий ассортимент продукции", "Развитая сеть дистрибуции"],
            weaknesses=["Высокая стоимость товаров относительно конкурентов", "Недостаточная скорость доставки в регионы", "Ограниченные акции и спецпредложения"],
            unique_offers=["Эксклюзивные партнерские программы", "Собственные разработки и инновации"],
            recommendations=["Оптимизировать логистику для сокращения сроков доставки", "Разработать новые акции для привлечения клиентов", "Снизить цены на ключевые позиции", "Усилить digital-маркетинг"],
            summary="Компания занимает сильные позиции, но есть возможности для роста за счет улучшения сервиса и ценовой политики."
        )

    def analyze_image(self, image_bytes: bytes) -> ImageAnalysis:
        """
        Анализирует изображение конкурента через GPT-4o.

        Args:
            image_bytes (bytes): Изображение в байтах.

        Returns:
            ImageAnalysis: Анализ изображения.
        """
        # Системный промпт для экспертного анализа изображения
        system_prompt = (
            "Ты — эксперт по визуальному маркетингу и брендингу. "
            "Проанализируй изображение конкурента максимально подробно. "
            "Ответ строго в формате JSON с ключами: description (детальное описание), insights (маркетинговые инсайты, 3-5), "
            "visual_style_score (оценка визуального стиля от 0 до 10), recommendations (конкретные рекомендации по улучшению, 3-5). "
            "Оцени цветовую палитру, типографику, композицию, UX/UI, соответствие целевой аудитории. "
            "Пиши на русском, используй профессиональные термины."
        )
        # TODO: Реализовать реальный запрос к OpenAI Vision с этим промптом
        return ImageAnalysis(
            description="Баннер выполнен в фирменных цветах компании, использует современную типографику и лаконичную композицию. Преобладают холодные оттенки, акцент на CTA-кнопке.",
            insights=["Визуальный стиль соответствует целевой аудитории", "Элементы дизайна хорошо структурированы", "Использование фирменных цветов усиливает узнаваемость", "Присутствует четкий призыв к действию"],
            visual_style_score=9,
            recommendations=["Добавить больше уникальных графических элементов", "Упростить фон для лучшей читаемости", "Усилить контраст между текстом и фоном", "Провести A/B тестирование разных вариантов CTA"]
        )

openai_service = OpenAIService()
